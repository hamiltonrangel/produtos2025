<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Pre√ßos</title> <style>
        /* Estilo geral para o corpo da p√°gina */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; /* Fontes padr√£o de sistemas modernos */
            background-color: #ffffff; /* Cor de fundo branco */
            /* background-color: #f0f2f5; /* Cor de fundo cinza claro */
            color: #333; /* Cor do texto principal (cinza escuro) */
            display: flex; /* Ativa o layout flexbox para alinhar os itens */
            flex-direction: column; /* Organiza os itens em uma coluna, um abaixo do outro */
            align-items: center; /* Centraliza os itens horizontalmente */
            padding: 1em; /* Adiciona um espa√ßamento interno */
            min-height: 100vh; /* Garante que o corpo ocupe pelo menos 100% da altura da tela */
            margin: 0; /* Remove a margem padr√£o do navegador */
            box-sizing: border-box; /* Garante que padding e border n√£o aumentem o tamanho total do elemento */
            -webkit-user-select: none; /* Impede que o usu√°rio selecione texto no Chrome/Safari */
            user-select: none; /* Impede que o usu√°rio selecione texto */
            -webkit-touch-callout: none; /* Desativa o menu que aparece ao tocar e segurar em links no iOS */
            -webkit-tap-highlight-color: transparent; /* Remove o destaque cinza ao tocar em links/bot√µes no mobile */
        }

        /* Impede que imagens sejam arrastadas pelo usu√°rio */
        img {
            -webkit-user-drag: none;
            user-drag: none;
        }

        /* Estilo para os 'containers' principais (as telas do app) */
        .container {
            background-color: #fff; /* Fundo branco */
            padding: 1.5em; /* Espa√ßamento interno */
            border-radius: 8px; /* Bordas arredondadas */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Sombra suave */
            text-align: center; /* Alinha o texto ao centro */
            width: 100%; /* Ocupa 100% da largura dispon√≠vel */
            max-width: 500px; /* Mas com um limite m√°ximo de 500px de largura */
            margin-bottom: 1em; /* Margem na parte de baixo */
        }

        /* Estilos gerais para t√≠tulos e par√°grafos */
        h1 { margin-top: 0; font-size: 1.5em; }
        h2 { font-size: 1.2em; margin-top: 0; }
        p.slogan { font-weight: bold; color: #007bff; margin-top: 0; font-size: 1.1em; }
        p.explanation { margin-top: 0; margin-bottom: 1.5em; color: #555; font-size: 0.9em; }

        /* Estilo geral para campos de input e bot√µes */
        input, button {
            width: 100%; padding: 12px; margin-bottom: 0.8em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em;
        }
        /* Estilo espec√≠fico para bot√µes */
        button {
            color: white; /* Cor do texto branca */
            border: none; /* Sem borda */
            cursor: pointer; /* Mostra a "m√£ozinha" ao passar o mouse */
            transition: background-color 0.3s ease; /* Efeito suave na mudan√ßa de cor de fundo */
        }

        /* Cores de fundo para bot√µes espec√≠ficos, identificados por ID ou classe */
        #searchButton { background-color: #007bff; }
        #scanButtonHtml { background-color: #6c757d; }
        #saveButton { background-color: #28a745; display: none; margin-top: 1em; }
        #viewShoppingListButton { background-color: #fd7e14; }
        .market-button { background-color: #20c997; }
        #changeMarketButton { background-color: #6c757d; font-size: 0.8em; padding: 8px; }

        /* Estilo para a barra de informa√ß√µes do mercado selecionado */
        #marketInfoBar { display: flex; flex-direction: column; align-items: flex-start; gap: 0.5em; background-color: #e9ecef; padding: 0.8em 1em; border-radius: 6px; margin-bottom: 1.5em; }
        #marketInfoBar p { margin: 0; font-size: 0.9em; color: #495057; text-align: left;}

        /* ... (outros estilos com prop√≥sito similar aos j√° comentados) ... */
        
        /* Estilo aplicado a campos 'input' que est√£o no modo "somente leitura" (readonly) */
        input[readonly] {
            background-color: #e9ecef; /* Fundo cinza claro para indicar que est√° desativado */
            color: #6c757d; /* Cor do texto mais clara */
            cursor: not-allowed; /* Mostra um √≠cone de "proibido" ao passar o mouse */
        }
    </style>
</head>

<body>
    <div id="selectionView" class="container">
        <h2>Bem-vindo(a)!</h2>
        <p class="slogan">Juntos, encontramos o melhor pre√ßo.</p>
        <p class="explanation">Este √© um app colaborativo. Os pre√ßos s√£o atualizados pelos pr√≥prios usu√°rios. Contribua tamb√©m!</p>
        <hr style="border: none; border-top: 1px solid #eee; margin-bottom: 1.5em;">
        <h1>Onde voc√™ est√°?</h1>
        <button class="market-button" data-market-name="SILVA" data-market-key="supermercado1">SILVA</button>
        <button class="market-button" data-market-name="SHIBATA" data-market-key="supermercado2">SHIBATA</button>
        <button class="market-button" data-market-name="SEMAR" data-market-key="supermercado3">SEMAR</button>
        <button class="market-button" data-market-name="P√ÉO DE A√á√öCAR" data-market-key="supermercado4">P√ÉO DE A√á√öCAR</button>
    </div>

    <div id="searchView" class="container" style="display: none;">
        <div id="marketInfoBar">
            <p>Comprando em: <b id="selectedMarketName"></b></p>
            <button id="changeMarketButton">Trocar de Supermercado</button>
        </div>
        <h1>Buscador de Pre√ßos</h1>
        <input type="text" id="barcodeInput" placeholder="Digite ou escaneie o c√≥digo" inputmode="numeric" pattern="[0-9]*">
        <button id="searchButton">Buscar Produto</button>
        <button id="scanButtonHtml">üì∑ Ler C√≥digo de Barras</button>
        <hr style="border: none; border-top: 1px solid #eee; margin: 1.5em 0;">
        <button id="viewShoppingListButton">Ver Lista de Compras</button>
        <div id="product-display">
            <h2 id="productName"></h2>
            <img id="productImage" src="" alt="">
            <div class="icons-container">
                <span id="cartFeedback"></span>
                <input type="number" id="quantityInput" value="1" min="1" inputmode="numeric">
                <span id="shoppingListIcon">üõí</span>
            </div>
            <div id="prices-section">
                <h4>Pre√ßos:</h4>
                <div class="prices-grid">
                    <div class="price-input-group"> <label for="supermercado1">SILVA:</label> <input type="text" id="supermercado1" placeholder="0,00" inputmode="decimal"> </div>
                    <div class="price-input-group"> <label for="supermercado2">SHIBATA:</label> <input type="text" id="supermercado2" placeholder="0,00" inputmode="decimal"> </div>
                    <div class="price-input-group"> <label for="supermercado3">SEMAR:</label> <input type="text" id="supermercado3" placeholder="0,00" inputmode="decimal"> </div>
                    <div class="price-input-group"> <label for="supermercado4">P√ÉO DE A√á√öCAR:</label> <input type="text" id="supermercado4" placeholder="0,00" inputmode="decimal"> </div>
                </div>
            </div>
        </div>
        <button id="saveButton">Gravar Pre√ßos</button>
        <div id="statusMessage"></div>
    </div>

    <div id="shoppingListView" class="container" style="display: none;">
        <h1>Lista de Compras</h1>
        <div id="shoppingList"></div>
        <h2 style="text-align: right; margin: 1em 0;">Total Geral: <b id="shoppingListTotal">R$ 0,00</b></h2>
        <button id="clearListButton">Limpar Lista</button>
        <hr style="border: none; border-top: 1px solid #eee; margin: 1.5em 0;">
        <button class="backToSearchButton">Voltar</button>
    </div>

    <script>
        // --- VARI√ÅVEIS GLOBAIS ---
        // URL do seu Google Apps Script publicado. √â o "backend" do nosso app.
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyynicYvXCkvHSH55Wa9I2C2JwrVn01CTLGM9iRptPGxhUcVIYCumDFTkqknAL3FNk/exec";
        // Vari√°vel para guardar qual supermercado o usu√°rio selecionou. Come√ßa como nula.
        let selectedSupermarket = null;

        // Objeto 'ui' para guardar refer√™ncias a todos os elementos HTML que vamos manipular.
        // Isso organiza o c√≥digo e evita repetir document.getElementById() toda hora.
        const ui = {
            selectionView: document.getElementById('selectionView'), marketButtons: document.querySelectorAll('.market-button'),
            searchView: document.getElementById('searchView'), selectedMarketName: document.getElementById('selectedMarketName'), changeMarketButton: document.getElementById('changeMarketButton'), barcodeInput: document.getElementById('barcodeInput'), searchButton: document.getElementById('searchButton'), scanButtonHtml: document.getElementById('scanButtonHtml'), saveButton: document.getElementById('saveButton'), productImage: document.getElementById('productImage'), productName: document.getElementById('productName'), statusMessage: document.getElementById('statusMessage'), pricesSection: document.getElementById('prices-section'), shoppingListIcon: document.getElementById('shoppingListIcon'), quantityInput: document.getElementById('quantityInput'),
            cartFeedback: document.getElementById('cartFeedback'),
            shoppingListView: document.getElementById('shoppingListView'), viewShoppingListButton: document.getElementById('viewShoppingListButton'), shoppingList: document.getElementById('shoppingList'), shoppingListTotal: document.getElementById('shoppingListTotal'),
            clearListButton: document.getElementById('clearListButton'), backToSearchButtons: document.querySelectorAll('.backToSearchButton'),
            priceInputs: { supermercado1: document.getElementById('supermercado1'), supermercado2: document.getElementById('supermercado2'), supermercado3: document.getElementById('supermercado3'), supermercado4: document.getElementById('supermercado4') }
        };
        
        // --- L√ìGICA DA LISTA DE COMPRAS (usando o localStorage do navegador) ---
        // O localStorage guarda dados mesmo que o usu√°rio feche a aba.
        
        // Pega a lista de compras do localStorage. Se n√£o existir, retorna um array vazio.
        function getShoppingListFromLocal() { const listJSON = localStorage.getItem('shoppingList'); return listJSON ? JSON.parse(listJSON) : []; }
        // Salva a lista de compras no localStorage.
        function saveShoppingListToLocal(list) { localStorage.setItem('shoppingList', JSON.stringify(list)); }
        // Adiciona um item √† lista. Se o item j√° existe (mesmo c√≥digo e mercado), apenas atualiza a quantidade.
        function addToShoppingListLocal(itemToAdd) { let list = getShoppingListFromLocal(); const existingItem = list.find(item => item.codigo === itemToAdd.codigo && item.supermercado === itemToAdd.supermercado); if (existingItem) { existingItem.quantidade += itemToAdd.quantidade; existingItem.preco_unitario = itemToAdd.preco_unitario; } else { list.push(itemToAdd); } saveShoppingListToLocal(list); }
        // Atualiza a quantidade de um item na lista. Se a quantidade for zero ou menos, o item √© removido.
        function updateShoppingListItemLocal(barcode, marketName, newQuantity) { let list = getShoppingListFromLocal(); if (newQuantity <= 0) { list = list.filter(item => !(item.codigo === barcode && item.supermercado === marketName)); } else { const itemToUpdate = list.find(item => item.codigo === barcode && item.supermercado === marketName); if (itemToUpdate) { itemToUpdate.quantidade = newQuantity; } } saveShoppingListToLocal(list); }
        // Limpa completamente a lista de compras do localStorage.
        function clearShoppingListLocal() { localStorage.removeItem('shoppingList'); }
        
        // --- EVENT LISTENERS (OUVINTES DE EVENTOS) ---
        // Aqui, dizemos ao JavaScript o que fazer quando o usu√°rio interagir com a p√°gina.

        // Para cada bot√£o de supermercado, adiciona um "ouvinte" de clique que chama a fun√ß√£o 'selectSupermarket'.
        ui.marketButtons.forEach(btn => btn.addEventListener('click', selectSupermarket));
        
        // Adiciona um ouvinte ao bot√£o "Trocar de Supermercado".
        ui.changeMarketButton.addEventListener('click', () => {
            ui.barcodeInput.value = ''; // 1. Limpa o campo do c√≥digo de barras.
            clearUi();                   // 2. Limpa toda a informa√ß√£o do produto anterior.
            showSelectionView();         // 3. Mostra a tela inicial de sele√ß√£o.
        });
        
        ui.viewShoppingListButton.addEventListener('click', showShoppingListView);
        ui.clearListButton.addEventListener('click', clearShoppingList);
        ui.backToSearchButtons.forEach(btn => btn.addEventListener('click', showSearchView));
        ui.shoppingList.addEventListener('click', handleShoppingListItemClick);
        ui.shoppingListIcon.addEventListener('click', addToShoppingList);
        // Tenta se comunicar com o app Kodular. Se n√£o estiver no app, mostra um alerta.
        ui.scanButtonHtml.addEventListener('click', () => { try { const mensagem = "ACIONAR_SCANNER"; window.AppInventor.setWebViewString(mensagem); } catch (error) { alert("O leitor de c√≥digo de barras s√≥ funciona dentro do aplicativo."); } });
        ui.searchButton.addEventListener('click', buscarProduto);
        ui.saveButton.addEventListener('click', salvarPrecos);
        // Permite buscar pressionando a tecla "Enter" no campo de c√≥digo de barras.
        ui.barcodeInput.addEventListener('keyup', e => e.key === 'Enter' && buscarProduto());
        // Garante que o usu√°rio use v√≠rgula como separador decimal nos pre√ßos.
        Object.values(ui.priceInputs).forEach(input => { input.addEventListener('input', (event) => { event.target.value = event.target.value.replace('.', ','); }); });
        
        // --- FUN√á√ïES PRINCIPAIS ---

        // Fun√ß√µes para controlar qual "tela" (container) √© mostrada ao usu√°rio.
        function showSelectionView() { ui.selectionView.style.display = 'block'; ui.searchView.style.display = 'none'; ui.shoppingListView.style.display = 'none'; }
        function showSearchView() { ui.selectionView.style.display = 'none'; ui.searchView.style.display = 'block'; ui.shoppingListView.style.display = 'none'; }
        
        // Chamada quando um bot√£o de supermercado √© clicado.
        function selectSupermarket(event) {
            const button = event.target; // Pega o bot√£o que foi clicado.
            // Guarda o nome e a chave do mercado (dos atributos 'data-*') na vari√°vel global.
            selectedSupermarket = { name: button.dataset.marketName, key: button.dataset.marketKey };
            ui.selectedMarketName.textContent = selectedSupermarket.name; // Mostra o nome na tela.
            showSearchView(); // Muda para a tela de busca.
        }

        // Adiciona o produto atual √† lista de compras local.
        function addToShoppingList() {
            const quantity = parseInt(ui.quantityInput.value, 10); // Pega a quantidade.
            if (!quantity || quantity < 1) { alert("Por favor, insira uma quantidade v√°lida."); return; } // Valida√ß√£o.
            const priceInput = ui.priceInputs[selectedSupermarket.key]; // Pega o campo de pre√ßo do mercado certo.
            // Converte o pre√ßo de "1,23" (texto) para 1.23 (n√∫mero).
            const price = priceInput ? parseFloat(priceInput.value.replace(',', '.')) : null;
            if (price === null || isNaN(price) || price <= 0) { alert(`Pre√ßo para ${selectedSupermarket.name} n√£o √© v√°lido ou n√£o foi preenchido.`); return; } // Valida√ß√£o do pre√ßo.
            // Cria um objeto representando o item.
            const item = { supermercado: selectedSupermarket.name, codigo: ui.barcodeInput.value.trim(), nome: ui.productName.textContent, quantidade: quantity, preco_unitario: price };
            addToShoppingListLocal(item); // Adiciona na lista.
            // Feedback visual para o usu√°rio.
            ui.cartFeedback.textContent = '‚úÖ Adicionado!';
            ui.cartFeedback.style.display = 'inline';
            setTimeout(() => { ui.cartFeedback.style.display = 'none'; }, 2000); // Esconde a mensagem ap√≥s 2 segundos.
        }
        
        // ... (outras fun√ß√µes da lista de compras com l√≥gica similar) ...

        // Limpa a interface, resetando todos os campos e informa√ß√µes de produto.
        function clearUi() {
            ui.shoppingListIcon.style.display = 'none';
            ui.quantityInput.style.display = 'none';
            ui.cartFeedback.style.display = 'none';
            ui.quantityInput.value = '1';
            ui.productImage.src = '';
            ui.productImage.alt = '';
            ui.productName.textContent = '';
            ui.pricesSection.style.display = 'none';
            ui.saveButton.style.display = 'none';
            // Reseta todos os inputs de pre√ßo para o estado inicial.
            Object.values(ui.priceInputs).forEach(input => {
                input.value = '';
                input.readOnly = false;
                input.style.border = "1px solid #ccc";
            });
            if (ui.statusMessage) ui.statusMessage.textContent = '';
        }

        // Controla quais campos de pre√ßo s√£o edit√°veis.
        function atualizarEstadoDosInputsDePreco() {
            if (!selectedSupermarket) return; // Se nenhum mercado foi selecionado, n√£o faz nada.
            // Itera sobre cada input de pre√ßo.
            for (const key in ui.priceInputs) {
                const input = ui.priceInputs[key];
                // Se a chave do input (ex: 'supermercado1') for a mesma do mercado selecionado...
                if (key === selectedSupermarket.key) {
                    input.readOnly = false; // ...o campo fica edit√°vel.
                    input.style.border = "2px solid #007bff"; // E ganha uma borda de destaque.
                } else {
                    input.readOnly = true; // ...sen√£o, o campo fica bloqueado (somente leitura).
                    input.style.border = "1px solid #ccc"; // E volta para a borda normal.
                }
            }
        }

        // Fun√ß√£o ass√≠ncrona para buscar o produto (pode demorar, pois acessa a internet).
        async function buscarProduto() {
            const barcode = ui.barcodeInput.value.trim(); // Pega o c√≥digo de barras e remove espa√ßos.
            clearUi(); // Limpa a tela antes de come√ßar.
            if (barcode === '') { return; } // Se o campo estiver vazio, n√£o faz nada.

            ui.statusMessage.textContent = 'Buscando...';
            ui.searchButton.disabled = true; // Desabilita os bot√µes para evitar cliques duplos.
            ui.scanButtonHtml.disabled = true;

            try { // O bloco 'try' tenta executar um c√≥digo que pode dar erro.
                // 1. Tenta buscar na nossa planilha (Google Apps Script).
                const sheetResponse = await fetch(`${SCRIPT_URL}?barcode=${barcode}`);
                const sheetResult = await sheetResponse.json();
                if (sheetResult.status === 'success') { // Se encontrou na planilha...
                    // ...preenche todas as informa√ß√µes na tela.
                    ui.statusMessage.textContent = 'Encontrado!';
                    const data = sheetResult.data;
                    ui.productName.textContent = data.nome;
                    ui.productImage.src = data.imageUrl || '';
                    ui.priceInputs.supermercado1.value = data.supermercado1 ? String(data.supermercado1).replace('.', ',') : '';
                    ui.priceInputs.supermercado2.value = data.supermercado2 ? String(data.supermercado2).replace('.', ',') : '';
                    ui.priceInputs.supermercado3.value = data.supermercado3 ? String(data.supermercado3).replace('.', ',') : '';
                    ui.priceInputs.supermercado4.value = data.supermercado4 ? String(data.supermercado4).replace('.', ',') : '';
                    
                    atualizarEstadoDosInputsDePreco(); // Bloqueia os campos de pre√ßo corretos.
                    
                    ui.pricesSection.style.display = 'block'; // Mostra a se√ß√£o de pre√ßos.
                    ui.saveButton.style.display = 'block'; // Mostra o bot√£o de salvar.
                    return; // Encerra a fun√ß√£o aqui, pois j√° achamos o produto.
                }

                // 2. Se n√£o encontrou na planilha, tenta buscar na API externa Open Food Facts.
                ui.statusMessage.textContent = 'N√£o encontrado. Buscando online...';
                const foodFactsUrl = `https://br.openfoodfacts.org/api/v0/product/${barcode}.json`;
                const foodFactsResponse = await fetch(foodFactsUrl);
                const foodFactsData = await foodFactsResponse.json();
                if (foodFactsData.status === 1 && foodFactsData.product) { // Se encontrou online...
                    // ...preenche o nome e a imagem. Os pre√ßos ficam em branco para o usu√°rio preencher.
                    ui.statusMessage.textContent = 'Encontrado online!';
                    ui.productName.textContent = foodFactsData.product.product_name || 'Nome n√£o encontrado';
                    ui.productImage.src = foodFactsData.product.image_url || '';

                    atualizarEstadoDosInputsDePreco();
                    
                    ui.pricesSection.style.display = 'block';
                    ui.saveButton.style.display = 'block';
                } else { // Se n√£o encontrou em nenhum dos dois lugares...
                    ui.statusMessage.textContent = 'Produto n√£o encontrado.';
                }
            } catch (error) { // Se qualquer parte do 'try' der um erro de rede...
                ui.statusMessage.textContent = 'Ocorreu um erro na comunica√ß√£o.';
            } finally { // O bloco 'finally' sempre executa no final, com ou sem erro.
                ui.searchButton.disabled = false; // Reabilita os bot√µes para o usu√°rio.
                ui.scanButtonHtml.disabled = false;
            }
        }

        // Fun√ß√£o ass√≠ncrona para salvar os pre√ßos na planilha.
        async function salvarPrecos() {
            // Coleta todos os dados da tela.
            const barcode = ui.barcodeInput.value.trim();
            const name = ui.productName.textContent;
            const imageUrl = ui.productImage.src;
            const prices = [
                ui.priceInputs.supermercado1.value.replace(',', '.'),
                ui.priceInputs.supermercado2.value.replace(',', '.'),
                ui.priceInputs.supermercado3.value.replace(',', '.'),
                ui.priceInputs.supermercado4.value.replace(',', '.')
            ];

            ui.statusMessage.textContent = 'Gravando na planilha...';
            ui.saveButton.disabled = true; // Desabilita o bot√£o para evitar cliques duplos.

            try {
                const postData = { barcode, name, prices, imageUrl };
                // Envia os dados para o Google Apps Script.
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', // M√©todo de envio.
                    // A corre√ß√£o do CORS: enviamos como 'text/plain' para evitar o bloqueio de seguran√ßa do navegador.
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify(postData), // Converte o objeto de dados para texto (JSON).
                });
                
                const result = await response.json(); // Interpreta a resposta do servidor.

                if (result.status === 'success') { // Se o servidor respondeu com sucesso...
                    ui.statusMessage.innerHTML = `‚úÖ ${result.message}`; // Mostra a mensagem de sucesso.
                } else {
                    ui.statusMessage.textContent = `Erro ao gravar: ${result.message}`; // Mostra a mensagem de erro.
                }
            } catch (error) {
                ui.statusMessage.textContent = 'Falha na comunica√ß√£o ao gravar os dados.';
                console.error('Erro em salvarPrecos:', error); // Mostra o erro detalhado no console do navegador.
            } finally {
                ui.saveButton.disabled = false; // Reabilita o bot√£o no final.
            }
        }
        
        // Adiciona um ouvinte que espera a p√°gina HTML ser completamente carregada para ent√£o chamar a fun√ß√£o 'showSelectionView'.
        document.addEventListener('DOMContentLoaded', showSelectionView);
    </script>
</body>

</html>
