// Define os nomes das abas da planilha
const SHEET_PAGINA1 = "Página1";
const SHEET_FAVORITOS = "Favoritos";
const SHEET_LISTA = "Lista de Compras";

// Colunas (A=1, B=2, C=3, etc.)
const COL = {
  BARCODE: 1,
  NAME: 2,
  PRICE_START: 3,
  IMAGE_URL: 7
};

// --- FUNÇÃO GET (BUSCA DADOS) ---
function doGet(e) {
  try {
    switch (e.parameter.action) {
      case 'getFavorites':
        return getAllFavorites();
      case 'getShoppingList':
        return getShoppingList();
      default:
        return getProductByBarcode(e);
    }
  } catch (error) {
    return jsonOutput({ status: "error", message: "Erro na função GET: " + error.message });
  }
}

// --- FUNÇÃO POST (SALVA DADOS) ---
function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    
    switch (body.action) {
      case 'favorite':
        return handleFavorite(body);
      case 'unfavorite':
        return handleUnfavorite(body);
      case 'addToShoppingList':
        return handleAddToShoppingList(body);
      case 'updateShoppingListItem':
        return handleUpdateShoppingListItem(body);
      case 'clearShoppingList':
        return handleClearShoppingList();
      // A ação 'deleteFromShoppingList' foi removida pois foi substituída por 'update' com qtd 0
      default:
        return handleSave(body); // Salvar preços na Página1
    }
  } catch (error) {
    return jsonOutput({ status: "error", message: "Erro na função POST: " + error.message });
  }
}

// --- FUNÇÕES DE LÓGICA ---

function handleSave(body) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_PAGINA1);
  const { barcode, name, prices, imageUrl } = body;
  if (!barcode || !prices) { return jsonOutput({ status: "error", message: "Dados incompletos para salvar." }); }
  const numericPrices = prices.map(price => price ? parseFloat(price) : null);
  const existingRowData = findRowByBarcode(sheet, barcode);
  if (existingRowData) {
    const rowIndex = existingRowData.rowIndex;
    sheet.getRange(rowIndex, COL.NAME).setValue(name);
    sheet.getRange(rowIndex, COL.IMAGE_URL).setValue(imageUrl);
    sheet.getRange(rowIndex, COL.PRICE_START, 1, 4).setValues([numericPrices]);
    return jsonOutput({ status: "success", message: "Preços atualizados." });
  } else {
    const newRow = [barcode, name, ...numericPrices, imageUrl];
    sheet.appendRow(newRow);
    return jsonOutput({ status: "success", message: "Novo produto gravado." });
  }
}

function handleFavorite(body) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_FAVORITOS);
  const { barcode, name, prices, imageUrl } = body;
  if (!barcode) { return jsonOutput({ status: "error", message: "Dados incompletos." }); }
  const existingFavorite = findRowByBarcode(sheet, barcode);
  if (existingFavorite) { return jsonOutput({ status: "already_exists", message: "Produto já está nos favoritos." }); }
  const numericPrices = prices.map(price => price ? parseFloat(price) : null);
  const newRow = [barcode, name, ...numericPrices, imageUrl];
  sheet.appendRow(newRow);
  return jsonOutput({ status: "success", message: "Adicionado aos favoritos!" });
}

function handleUnfavorite(body) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_FAVORITOS);
  const { barcode } = body;
  if (!barcode) { return jsonOutput({ status: "error", message: "Código de barras não fornecido." }); }
  const favoriteRow = findRowByBarcode(sheet, barcode);
  if (favoriteRow) {
    sheet.deleteRow(favoriteRow.rowIndex);
    return jsonOutput({ status: "success", message: "Removido dos favoritos!" });
  }
  return jsonOutput({ status: "not_found", message: "Produto não estava nos favoritos." });
}

function handleAddToShoppingList(body) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_LISTA);
  const { barcode, name, quantity, price } = body;
  if (!barcode || !name || !quantity || price === null || price === undefined) { return jsonOutput({ status: "error", message: "Dados incompletos para a lista." }); }
  const numericQuantity = parseInt(quantity, 10);
  const numericPrice = parseFloat(price);
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == barcode) {
      const rowIndex = i + 1;
      const existingQuantity = parseInt(data[i][2], 10) || 0;
      const newQuantity = existingQuantity + numericQuantity;
      sheet.getRange(rowIndex, 3).setValue(newQuantity);
      sheet.getRange(rowIndex, 4).setValue(numericPrice);
      return jsonOutput({ status: "updated", message: "Quantidade atualizada!" });
    }
  }
  sheet.appendRow([barcode, name, numericQuantity, numericPrice]);
  return jsonOutput({ status: "success", message: "Adicionado à lista!" });
}

function handleUpdateShoppingListItem(body) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_LISTA);
  const { barcode, newQuantity } = body;
  if (!barcode || newQuantity === undefined) { return jsonOutput({ status: "error", message: "Dados incompletos para atualizar." }); }
  const numericQuantity = parseInt(newQuantity, 10);
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == barcode) {
      const rowIndex = i + 1;
      if (numericQuantity <= 0) {
        sheet.deleteRow(rowIndex);
        return jsonOutput({ status: "success", message: "Item removido." });
      } else {
        sheet.getRange(rowIndex, 3).setValue(numericQuantity);
        return jsonOutput({ status: "success", message: "Quantidade atualizada." });
      }
    }
  }
  return jsonOutput({ status: "not_found", message: "Item não encontrado." });
}

function handleClearShoppingList() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_LISTA);
  if (sheet.getLastRow() > 1) {
    sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
  }
  return jsonOutput({ status: "success", message: "Lista de compras limpa!" });
}

// --- FUNÇÕES AUXILIARES ---
function getShoppingList() { const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_LISTA); const data = sheet.getDataRange().getValues(); const shoppingList = []; for (let i = 1; i < data.length; i++) { if (data[i][0]) { shoppingList.push({ codigo: data[i][0], nome: data[i][1], quantidade: data[i][2], preco_unitario: data[i][3] }); } } return jsonOutput({ status: "success", data: shoppingList }); }
function getAllFavorites() { const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_FAVORITOS); const data = sheet.getDataRange().getValues(); const favoritesList = []; for (let i = 1; i < data.length; i++) { if (data[i][0]) { favoritesList.push({ codigo: data[i][COL.BARCODE - 1], nome: data[i][COL.NAME - 1], supermercado1: data[i][COL.PRICE_START - 1], supermercado2: data[i][COL.PRICE_START], supermercado3: data[i][COL.PRICE_START + 1], supermercado4: data[i][COL.PRICE_START + 2], imageUrl: data[i][COL.IMAGE_URL - 1] }); } } return jsonOutput({ status: "success", data: favoritesList }); }
function getProductByBarcode(e) { const sheetP1 = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_PAGINA1); const barcode = e.parameter.barcode; if (!barcode) { return jsonOutput({ status: "error", message: "Código de barras não fornecido." }); } const data = findRowByBarcode(sheetP1, barcode); if (data) { const sheetFav = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_FAVORITOS); data.isFavorite = !!findRowByBarcode(sheetFav, barcode); return jsonOutput({ status: "success", data: data }); } else { return jsonOutput({ status: "not_found", message: "Produto não cadastrado." }); } }
function findRowByBarcode(sheet, barcode) { const data = sheet.getRange("A:G").getValues(); for (let i = 1; i < data.length; i++) { if (data[i][COL.BARCODE - 1] == barcode && data[i][COL.BARCODE - 1] !== '') { return { rowIndex: i + 1, codigo: data[i][COL.BARCODE - 1], nome: data[i][COL.NAME - 1], supermercado1: data[i][COL.PRICE_START - 1], supermercado2: data[i][COL.PRICE_START], supermercado3: data[i][COL.PRICE_START + 1], supermercado4: data[i][COL.PRICE_START + 2], imageUrl: data[i][COL.IMAGE_URL - 1] }; } } return null; }
function jsonOutput(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
